# CivicStat â€“ Handover & To-Do's

**Date:** 5 February 2026  
**Project:** Neutrale Transparantie-Platform (CivicStat)  
**Repo:** `/Users/koenbekkering/Documents/New project`

---

## What Is This Project?

A neutral, auditable platform that makes Dutch Tweede Kamer data (motions, votes, MPs, parties) accessible and traceable. Built with a principle of no political rankings, labels, or recommendations â€” only facts with source attribution.

---

## Architecture

| Layer | Tech | Location | Deployed To |
|-------|------|----------|-------------|
| **Web** | Next.js (App Router) | `civicstat-web/` | Vercel â€“ civicstat-web.vercel.app |
| **API** | NestJS (Hono on Fly) | `apps/api/` | Fly.io â€“ civicstat-api.fly.dev |
| **DB** | PostgreSQL + Prisma | `packages/db/` | Neon (serverless Postgres) |
| **ETL** | TypeScript scripts | `packages/etl/` | Run manually (`npx tsx src/index.ts`) |
| **Shared** | Types/utils | `packages/shared/` | â€” |

Note: there are **two web directories** â€” `apps/web/` (monorepo placeholder, may be empty) and `civicstat-web/` (the actual deployed Next.js app with its own git). Clarify which is canonical.

---

## Current State (What Works)

### ETL Pipeline (`packages/etl/`)
All four ingest steps run successfully via `npx tsx src/index.ts all`:

| Step | Entity | Source | Status | Notes |
|------|--------|--------|--------|-------|
| **fracties** | Parties | TK OData `Fractie` | âœ… 58 ingested | |
| **kamerleden** | MPs | TK OData `Persoon` + `FractieZetelPersoon` | âœ… 3070 personen, 1183 assignments | Many skipped (no active fractie) |
| **moties** | Motions | TK OData `Zaak` (Soort='Motie') | âœ… 100 ingested | |
| **stemmingen** | Votes | TK OData `Besluit` â†’ `Stemming` | âœ… 50 ingested | All "Met handopsteken", 0 failures |

### API (NestJS)
Endpoints live at `civicstat-api.fly.dev`:
- `/health` â€“ Health check
- `/motions` â€“ List/detail motions
- `/votes` â€“ List/detail votes  
- `/parties` â€“ List/detail parties
- `/members` â€“ List/detail MPs

### Web (Next.js)
Routes at `civicstat-web.vercel.app`:
- `/` â€“ Landing page with search bar (non-functional) and nav
- `/moties` â€“ Motions listing
- `/kamerleden` â€“ MPs listing
- `/partijen` â€“ Parties listing
- `/verbinding` â€“ "What connects us" (consensus stats placeholder)
- `/transparantie` â€“ Transparency/audit page
- `/consultaties` â€“ Consultation feature (skeleton)
- `/portal` â€“ Auth/portal skeleton
- `/api` â€“ API docs page

### Database (Prisma Schema)
Full schema in `packages/db/prisma/schema.prisma`. Key models:
- `Party`, `Mp`, `Motion`, `MotionSponsor`
- `Vote`, `VoteRecord` (individual MP votes)
- `Program`, `ProgramPassage`, `MotionProgramMatch` (matching engine)
- `Consultation`, `ConsultationQuestion`, `ConsultationResponse`
- `User`, `AuditLog`, `AlgorithmVersion`, `RawIngest`, `SyncState`

---

## Key Technical Knowledge (TK OData API)

The Tweede Kamer API at `https://gegevensmagazijn.tweedekamer.nl/OData/v4/2.0/` has a confusing naming scheme. Here's the correct model:

- **`Stemming`** = party-level vote record (e.g., "VVD voted Tegen"), NOT an overall vote decision
- **`Besluit`** = the actual vote decision, contains `StemmingsSoort` ("Hoofdelijk" or "Met handopsteken")
- **Vote date** comes from `Besluit` â†’ `Agendapunt` â†’ `Activiteit.Datum`, NOT from `Stemming`
- **Field names** use underscores: `Besluit_Id`, `Fractie_Id`, `Persoon_Id` (not camelCase)
- **"Hoofdelijk"** (roll-call) votes: individual `Stemming` records have `Persoon_Id` populated
- **"Met handopsteken"** votes: only party-level aggregates, no individual MP records
- **`Zaak`** (Soort='Motie') = motion entity; linked to `Besluit` via expand
- There is **no separate `Stem` entity** in the API

---

## To-Do's for Next Sessions

### ðŸ”´ Priority 1 â€” Core Data Quality

1. **Ingest more data.** Currently only 100 moties and 50 stemmingen are loaded. Run a full ingest or significantly increase limits to have meaningful data for the frontend.

2. **Link votes to motions.** Most votes currently have `motionId: null` because the Zaak IDs on Besluiten don't match the Zaak IDs ingested as motions. Investigate the `Besluit` â†’ `Zaak` relationship and ensure vote-motion linking works properly.

3. **Ingest "Hoofdelijk" (roll-call) votes.** The current 50 votes are all "Met handopsteken" (show of hands). Roll-call votes have individual MP-level data (`VoteRecord` entries). Need to ingest enough data to capture some roll-call votes, or specifically query for them.

4. **MotionSponsor ingestion.** The `MotionSponsor` join table exists in the schema but the ETL doesn't populate it yet. Sponsors are available via the TK API's `ZaakActor` entity.

### ðŸŸ¡ Priority 2 â€” Frontend

5. **Wire up the frontend to the API.** The Next.js pages exist but likely show placeholder/static content. Connect `/moties`, `/kamerleden`, `/partijen` pages to `civicstat-api.fly.dev` endpoints with real data fetching (server components or SWR).

6. **Search functionality.** The landing page has a search bar that doesn't do anything yet. Implement search across motions, votes, and MPs.

7. **Vote detail page.** Show vote results per party and (for roll-call votes) per individual MP. This is a key feature.

8. **MP profile page.** Show voting history, party membership, sponsored motions for each Kamerlid.

### ðŸŸ¡ Priority 3 â€” Matching & Analysis

9. **Program passage ingestion.** The `Program` and `ProgramPassage` tables exist but no ETL for party programs. Need to source election program PDFs/texts and ingest them.

10. **Motion-Program matching.** `MotionProgramMatch` table is ready. Implement keyword matching first, then semantic (with embeddings/pgvector). The `AlgorithmVersion` table supports versioned algorithms.

11. **Consensus/Verbinding statistics.** The `/verbinding` page should show which parties vote similarly. Requires sufficient vote data + a statistical calculation.

### ðŸŸ¢ Priority 4 â€” Platform Features

12. **Authentication & Portal.** User/MP auth flow. The `User` model and roles (`public`, `citizen`, `verified_mp`, `admin`, `auditor`) exist. Implement actual auth (e.g., NextAuth).

13. **Consultations.** The consultation models exist (questions, responses, status workflow). Build the MP portal for creating consultations and the citizen-facing response UI.

14. **Incremental sync.** The `SyncState` table exists for cursor-based incremental ingestion. Currently ETL does full re-fetches. Implement delta sync using `GewijzigdOp` timestamps.

15. **Scheduled ETL.** Set up a cron job or GitHub Action to run the ETL pipeline daily/hourly.

16. **Transparency/audit page.** The `/transparantie` route exists. Populate it with actual `RawIngest` stats, algorithm versions, and data provenance info.

### ðŸ”µ Housekeeping

17. **Clarify dual web directories.** `apps/web/` vs `civicstat-web/` â€” determine which is the canonical Next.js app and remove/consolidate the other.

18. **Update docs.** `docs/architecture.md` says API is NestJS, but the Fly.io deploy may be Hono. `docs/changelog.md` is outdated (still says "mock ingest"). Update to reflect current reality.

19. **Environment variables.** Ensure `.env.example` is complete and up-to-date for all packages.

---

## Useful Commands

```bash
# ETL
cd packages/etl
npx tsx src/index.ts all              # Full pipeline (limited)
npx tsx src/index.ts stemmingen 50    # Ingest 50 votes
npx tsx src/index.ts moties 200       # Ingest 200 motions
npx tsx src/index.ts quick            # Quick test run

# Database
cd packages/db
npx prisma studio                     # Visual DB browser
npx prisma migrate dev                # Run migrations
npx prisma generate                   # Regenerate client

# API
cd apps/api
npm run start:dev                     # Local API server (port 4000)

# Web
cd civicstat-web
npm run dev                           # Local Next.js dev server
```

---

## Key Files

| File | Purpose |
|------|---------|
| `packages/etl/src/index.ts` | ETL entry point (CLI) |
| `packages/etl/src/clients/tk-odata.ts` | TK OData API client + TypeScript interfaces |
| `packages/etl/src/ingest/stemmingen.ts` | Vote ingestion (Besluit â†’ Stemming model) |
| `packages/etl/src/ingest/moties.ts` | Motion ingestion |
| `packages/etl/src/ingest/fracties.ts` | Party ingestion |
| `packages/etl/src/ingest/kamerleden.ts` | MP ingestion |
| `packages/db/prisma/schema.prisma` | Complete database schema |
| `apps/api/src/modules/app.module.ts` | API module registration |
| `civicstat-web/app/page.tsx` | Landing page |
