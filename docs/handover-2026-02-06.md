# CivicStat â€” Session Handover (6 Feb 2026)

**Project:** Neutrale Transparantie-Platform (CivicStat)  
**Repo:** `/Users/koenbekkering/Documents/New project`  
**Goal:** Make Dutch parliamentary data (motions, votes, MPs, parties, election programs) accessible with a belofteâ†’stemgedrag (promiseâ†’voting behavior) matching feature.

---

## Architecture

| Layer | Tech | Location | Deployed To |
|-------|------|----------|-------------|
| Web | Next.js (App Router) | `civicstat-web/` | Vercel â€” civicstat-web.vercel.app |
| API | NestJS | `apps/api/` | Fly.io â€” civicstat-api.fly.dev |
| DB | PostgreSQL + Prisma | `packages/db/` | Neon (serverless Postgres) |
| ETL | TypeScript scripts | `packages/etl/` | Run manually via CLI |
| Shared | Types/utils | `packages/shared/` | â€” |

---

## Current Database State (as of 6 Feb 2026)

```json
{
  "moties": 5021,
  "votes": 4762,        // ~209 still missing, user running final ingest
  "votesMetMotie": 4077, // votes linked to a motion
  "voteRecords": 4987,   // individual MP-level vote records (hoofdelijk)
  "partijen": 58,
  "kamerleden": 150,
  "programs": 30,        // 15 Ã— TK2023 + 15 Ã— TK2025
  "programPassages": ~3456,
  "motionProgramMatches": 22203  // 62% of motions matched, avg 4.4 matches/motion
}
```

### StemmingsSoort breakdown:
- Met handopsteken: 4675 (party-level only)
- Hoofdelijk: 67 (individual MP votes â†’ VoteRecord entries)
- Zonder stemming: 20

---

## What Was Built This Session

### 1. Program Ingest ETL (`packages/etl/src/ingest/programmas.ts`)
- Downloads PDFs from DNPP repository (Rijksuniversiteit Groningen)
- Parses PDF â†’ text via `pdf-parse/lib/pdf-parse.js`
- Chunks text into passages (~500-800 words) with chapter/heading detection
- Stores in `Program` + `ProgramPassage` tables with full audit trail (SHA-256 hash, source URLs, RawIngest records)
- Manifest at `packages/etl/data/programs/manifest.json` with all 30 program URLs
- CLI: `npx tsx src/ingest/programmas.ts [--year 2023] [--party VVD] [--download-only]`

### 2. Keyword Matching (`packages/etl/src/matching/keyword-match.ts`)
- TF-IDF style keyword matching between motion texts and program passages
- Extracts keywords from motions, scores passages by overlap
- Bigrams weighted 2x (e.g., "openbaar vervoer" scores higher than single words)
- Extensive Dutch stopword list including parliamentary boilerplate
- Defaults: minScore=1.5, maxMatchesPerMotionParty=2
- Stores in `MotionProgramMatch` table with rationale JSON (algorithm, version, matched keywords, snippet)
- Registered in `AlgorithmVersion` table as `keyword_tfidf v1.0`
- CLI: `npx tsx src/matching/keyword-match.ts [--dry-run] [--limit 50] [--party VVD] [--year 2023]`

### 3. Schema Changes
- `Program` model extended: `title`, `secondarySourceUrl`, `pdfHash`, `pdfSizeBytes`, `downloadedAt`, `pageCount`, `@@unique([partyId, electionYear])`
- `Vote.motionId` is no longer `@unique` â€” relation is now 1-to-many (Motion.votes)
- Applied via `prisma db push` (not `migrate dev` â€” pgvector breaks shadow DB)

### 4. Data Quality Fixes (by user via Claude Code)
- Kamerleden ingest fixed: `FractieZetelPersoon` uses `FractieZetel_Id` â†’ mapped via `FractieZetel` to get `Fractie_Id`
- Stemmingen ingest scaled up from 50 to ~4,971 besluiten
- Vote-motion linking working: 4,077 of 4,762 votes linked to motions

---

## ETL Commands

```bash
cd "/Users/koenbekkering/Documents/New project/packages/etl"

# Core ingest
npx tsx src/index.ts all                    # Full pipeline
npx tsx src/index.ts fracties               # Parties
npx tsx src/index.ts kamerleden             # MPs
npx tsx src/index.ts moties [limit]         # Motions
npx tsx src/index.ts stemmingen [limit]     # Votes

# Program ingest
npx tsx src/index.ts programs               # All programs
npx tsx src/index.ts programs --year 2023   # Only TK2023
npx tsx src/index.ts programs --party VVD   # Single party

# Keyword matching
npx tsx src/index.ts match                  # Full run
npx tsx src/index.ts match --dry-run        # Preview
npx tsx src/index.ts match --limit 50       # Limited run
```

---

## Key Technical Notes

### TK OData API
- URL: `https://gegevensmagazijn.tweedekamer.nl/OData/v4/2.0/`
- `Stemming` = party-level vote record, NOT overall decision
- `Besluit` = vote decision, contains `StemmingsSoort`
- Vote date from `Besluit` â†’ `Agendapunt` â†’ `Activiteit.Datum`
- Field names use underscores: `Besluit_Id`, `Fractie_Id`
- "Hoofdelijk" = roll-call (individual MP records), "Met handopsteken" = party-level only

### Prisma/DB Gotchas
- Cannot use `prisma migrate dev` â€” pgvector extension breaks shadow DB
- Use `prisma db push --accept-data-loss` or manual SQL migrations
- pdf-parse v1.x requires import as `pdf-parse/lib/pdf-parse.js`
- tsx CLI guard: use `process.argv[1]?.includes('filename')` not `import.meta.url`

### NSC 2025 chunking issue
- NSC 2025 program generated 724 passages (vs ~60-140 for others) â€” many short numbered sections trigger chunking heuristics too frequently. Review chunking parameters for that program later.

---

## Priority To-Do's (Next Sessions)

### ðŸ”´ Priority 1 â€” Frontend Wiring (THE NEXT STEP)
The Next.js pages exist but show placeholder/static content. Wire them to real API data:

1. **Wire `/moties` page** to `civicstat-api.fly.dev/motions` â€” show real motions with vote results
2. **Wire `/kamerleden` page** to `civicstat-api.fly.dev/members` â€” show real MPs
3. **Wire `/partijen` page** to `civicstat-api.fly.dev/parties` â€” show real parties
4. **Build party detail page** â€” show party's programs, voting record, belofteâ†’stemgedrag matches
5. **Build motion detail page** â€” show vote breakdown per party + matched program passages (the USP)
6. **Search functionality** â€” landing page search bar is non-functional

### ðŸŸ¡ Priority 2 â€” Belofteâ†’Stemgedrag View (USP)
This is what makes CivicStat unique. Using the MotionProgramMatch data:
- Per party: show which election promises map to which votes
- Visual: program passage â†’ motion â†’ vote result (voor/tegen)
- Score/consistency metric per party per theme

### ðŸŸ¡ Priority 3 â€” Data Quality
- Remaining ~209 votes still ingesting
- MotionSponsor table still empty (needs ZaakActor ingest)
- Semantic matching (Phase 2) with pgvector embeddings

### ðŸŸ¢ Priority 4 â€” Production Features
- Incremental sync (SyncState table ready, delta logic not built)
- Scheduled ETL (GitHub Action cron)
- Authentication & portal (User model + roles exist)

---

## Key Files

| File | Purpose |
|------|---------|
| `packages/etl/src/index.ts` | ETL entry point (CLI router) |
| `packages/etl/src/ingest/programmas.ts` | Program PDF download + parse + chunk + store |
| `packages/etl/src/matching/keyword-match.ts` | Motionâ†”Program keyword matching |
| `packages/etl/data/programs/manifest.json` | All 30 program source URLs + DNPP IDs |
| `packages/db/prisma/schema.prisma` | Full database schema |
| `civicstat-web/app/page.tsx` | Next.js landing page |
| `civicstat-web/app/moties/` | Motions page (needs API wiring) |
| `civicstat-web/app/partijen/` | Parties page (needs API wiring) |
| `civicstat-web/app/kamerleden/` | MPs page (needs API wiring) |
| `apps/api/src/modules/app.module.ts` | NestJS API module registration |

---

## Design Reference
Two React prototypes exist in the project files (not deployed, for reference):
- `civicstat-prototype.jsx` â€” v1 with IBM Plex Sans + Fraunces fonts
- `civicstat-v3.jsx` â€” v3 with Instrument Serif + Plus Jakarta Sans, hero image, richer landing page

Both use inline styles, dark/light mode, mock data. The actual Next.js app should follow v3's design direction.
